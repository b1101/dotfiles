FROM debian:stable

RUN dpkg --add-architecture i386 \
  && DEBIAN_FRONTEND=noninteractive apt-get update -y -q \
  && DEBIAN_FRONTEND=noninteractive apt-get upgrade -y -q \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y -q \
    python python-pip python-dev \
    libc6:i386 libncurses5:i386 libstdc++6:i386 \
    crossbuild-essential-armhf build-essential git mercurial \
    cmake \
  && pip install mbed-cli

RUN apt-get install -y -q curl
RUN cd / && curl -sL https://developer.arm.com/-/media/Files/downloads/gnu-rm/6-2017q2/gcc-arm-none-eabi-6-2017-q2-update-linux.tar.bz2?revision=2cc92fb5-3e0e-402d-9197-bdfc8224d8a5?product=GNU%20Arm%20Embedded%20Toolchain,64-bit,,Linux,6-2017-q2-update | tar xj

ENV MBED_GCC_ARM_PATH /gcc-arm-none-eabi-6-2017-q2-update/bin

WORKDIR /mbed
VOLUME /mbed

# force mbed cli into installing missing python libs and toolchain
RUN cd /tmp && mbed new tmp0 && cd tmp0 && mbed compile >/dev/null 2>&1; cd .. && rm -r /tmp/tmp0 ; \
    mbed config --global toolchain gcc_arm

ENTRYPOINT [ "/usr/local/bin/mbed" ]
