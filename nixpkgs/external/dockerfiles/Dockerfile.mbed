FROM debian:unstable-slim

RUN dpkg --add-architecture i386 && \
    DEBIAN_FRONTEND=noninteractive apt-get update -y -q && \
    DEBIAN_FRONTEND=noninteractive apt-get upgrade -y -q && \
    DEBIAN_FRONTEND=noninteractive apt-get install -o APT::Immediate-Configure=false -f -y -q \
        python python-pip python-dev \
        libc6:i386 libncurses5:i386 libstdc++6:i386 \
        crossbuild-essential-armhf build-essential git mercurial \
        cmake curl && \
    pip install mbed-cli

RUN cd / && \
    curl -sLo gcc.tar.bz2 'https://developer.arm.com/-/media/Files/downloads/gnu-rm/9-2019q4/gcc-arm-none-eabi-9-2019-q4-major-aarch64-linux.tar.bz2?revision=4583ce78-e7e7-459a-ad9f-bff8e94839f1&la=en&hash=550DB9C0184B7C70B6C020A5DCBB9D1E156264B7' && \
    printf "0dfa059aae18fcf7d842e30c525076a4  gcc.tar.bz2" | md5sum -c && \
    tar xjf gcc.tar.bz2 && \
    rm -f gcc.tar.bz2

ENV MBED_GCC_ARM_PATH /gcc-arm-none-eabi-9-2019-q4-major/bin

WORKDIR /mbed
VOLUME /mbed

# force mbed cli into installing missing python libs and toolchain
RUN cd /tmp && mbed new tmp0 && cd tmp0 && mbed compile >/dev/null 2>&1; cd .. && rm -r /tmp/tmp0 ; \
    mbed config --global toolchain gcc_arm

ENTRYPOINT [ "/usr/local/bin/mbed" ]
