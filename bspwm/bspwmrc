#!/usr/bin/env bash
set -e

getXresColor() { 
    xrdb -query | grep "${1}:" | grep -oE '#[a-zA-Z0-9]{6}' | cut -c 1-
}

initBSPWM() {
    # Base16 Tomorrow-Dark
    bspc config active_border_color \#b4b7b4
    bspc config normal_border_color \#373b41
    bspc config focused_border_color \#cc6666
    bspc config presel_feedback_color \#cc6666
    bspc config normal_locked_border_color \#b5bd68
    bspc config focused_locked_border_color \#b5bd68
    bspc config normal_sticky_border_color \#de935f
    bspc config focused_sticky_border_color \#de935f
    bspc config normal_private_border_color \#282a2e
    bspc config focused_private_border_color \#282a2e
    
    bspc config border_width          2
    bspc config window_gap            5
    bspc config split_ratio           0.5
    bspc config borderless_monocle    true
    bspc config gapless_monocle       true
    bspc config focus_follows_pointer false || true
    bspc config click_to_focus        button1

    bspc rule -a "Spotify" desktop=^5
    bspc rule -a "Chromium-browser:crx_eggkanocgddhmamlbiijnphhppkpkmkl" state=floating
    bspc rule -a "mpv" state=floating
    
    local oldM=`bspc query -M`
    local opt=`randrctl`

    local desktops_per_mon=5
    for m in ${opt}; do
        local name="${m%:*}"
        local mode="${m#*:}"

        local pos="${mode#*x*+}"
        xrandr --output "${name}" --mode "${mode%+*+*}" --pos `tr '+' 'x' <<< ${mode#*x*+}`
        
        bspc wm -a "${name}" "${mode}"

        local names=()
        for j in `seq $desktops_per_mon`; do
            names+=("$name/$j")
        done
    
        bspc monitor "$name" -d ${names[@]}
    done

    for m in ${oldM}; do
        local first="`head -1 <<< ${opt} | cut -d':' -f1`/1"
        for n in `bspc query -N -m "${m}"`; do
            bspc node "${n}" -d ${first}
        done
        for d in `bspc query -D -m "${m}"`; do
            bspc desktop "${d}" -r
        done
        bspc monitor "${m}" -r
    done

    systemctl --user restart polybar
    feh --bg-fill "$HOME/pictures/wp"
}

initBSPWM
