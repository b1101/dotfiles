#!/usr/bin/env bash
getXresColor() xrdb -query | grep "${1}:" | grep -oE '#[a-zA-Z0-9]{6}' | cut -c 1-

initBSPWM() {
    bspc config border_width          2
    bspc config window_gap            5
    bspc config split_ratio           0.5
    bspc config borderless_monocle    true
    bspc config gapless_monocle       true
    bspc config focus_follows_pointer false
    bspc config click_to_focus        button1
    bspc config normal_border_color   `getXresColor base00`
    bspc config focused_border_color  `getXresColor base05`
    bspc config active_border_color   `getXresColor base03`
    bspc config presel_feedback_color `getXresColor base0A`
    
    bspc rule -a "Spotify" desktop=^5
    bspc rule -a "Chromium-browser:crx_eggkanocgddhmamlbiijnphhppkpkmkl" state=floating
    bspc rule -a "mpv" state=floating
    
    killall -qw polybar

    local oldM=`bspc query -M`
    local opt=`randrctl`

    local desktops_per_mon=5
    local i=0
    for m in ${opt}; do
        local name="${m%:*}"
        local mode="${m#*:}"

        local pos="${mode#*x*+}"
        xrandr --output "${name}" --mode "${mode%+*+*}" --pos `tr '+' 'x' <<< ${mode#*x*+}`
        
        bspc wm -a "${name}" "${mode}"

        local names=()
        for j in `seq $desktops_per_mon`; do
            names+=("$name/$j")
        done
    
        bspc monitor "$name" -d ${names[@]}

        local size="-small"
        [[ ${mode%x*} -gt 1920 ]] && size="-big"
    
        local suf=""
        [[ $i == 0 ]] && suf="-tray"
    
        MONITOR="${name}" polybar -r top${size}${suf}&

        let i++
    done

    for m in ${oldM}; do
        local first="`head -1 <<< ${opt} | cut -d':' -f1`/1"
        for n in `bspc query -N -m "${m}"`; do
            bspc node "${n}" -d ${first}
        done
        for d in `bspc query -D -m "${m}"`; do
            bspc desktop "${d}" -r
        done
        bspc monitor "${m}" -r
    done

    feh --bg-fill "$HOME/pictures/wp"
}

initBSPWM
